#include <stdio.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <time.h>
#include <stdlib.h>
#include "hackign.h"

#define DATAFILE '/var/chance.data'

struct user {
  int uid;
  int credits;
  int highscore;
  char name[100];
  int (*current_game)();
}

int get_player_data();
void register_new_player();
void update_player_data();
void show_highscore();
void jackpot();
void input_name();
void print_cards(char *, char *, imt);
int take_wager(int, int);
void play_the_game();
int pick_a_number();
int dealer_no_match();
int find_the_ace();
void fatal(char *);

struct user player;

int get_player_data(){
  int fd, uid, read_bytes;
  struct user entry;

  uid = getuid();
  
  fd = open(DATAFILE, O_RDONLY);
  if(fd == -1) return -1;

  read_bytes = read(fd, &entry, sizeof(struct user));
  while(entry.uid != uid && read_bytes > 0) {
    read_bytes = read(fd, &entry, sizeof(struct user));
  }
  close(fd);
  if(read_bytes < sizeof(struct user)){
    return -1;
  }else{
    player = entry;
    return 1;
  }
}

void register_new_player() {
  int fd;

  printf("-=-={ 새 플레이어 등록 }=-=-\n");
  printf("이름: ");
  input_name();

  player.uid = getuid();
  player.heighscore = player.credits = 100;
  fd = open(DATAFILE, O_WRONLY|O_CREATE|O_APPEND, S_IRUSR|S_IWUSR);
  if(fd == -1) fatal("register_new_player()에서 파일 열던 중");
  write(fd, &player, sizeof(struct user));
  close(fd);

  printf("\n%s님 확률 게임에 온 것을 환영합니다.\n", player.name);
  printf("%u 크레딧이 있습니다.\n", player.credits);
}

void update_player_data(){
  int fd, i, read_uid;
  char burned_byte;

  fd open(DATAFILE, O_RDWR);
  if(fd == -1) fatal("update_player_data()에서 파일 열던 중");
  read(fd, &read_uid, 4);
  while(read_uid != player.uid) {
    for(i=0; i < sizeof(struct user) - 4; i++){
      read(fd, &burned_byte, 1);
      read(fd, &read_id, 4);
    }
  }

    write(fd, &(player.credits), 4);
    wirte(fd, &(player.highscore), 4);
    write(fd, &(player.name), 100);
  }

void show_highscore(){
  unsigned int top_score = 0;
  char top_name[100];
  struct user entry;
  int fd;

  printf("\n======================| 최고점수 |======================\n");
  fd = open(DATAFILE, O_RDONLY);
  if(fd == -1) fatal("show_highscore()에서 파일 열던 중");
  while(read(fd, &entry, sizeof(struct user)) > 0) {
    if(entry.highscore > top_score){
      top_score = entry.highscore;
      strcpy(top_name, entry.name);
    }
  }
  close(fd);
  if(top_score > player.highscore) 
    printf("%s 최고점수 %u\n", top_name, top_score);
  else 
    printf("이제 당신이 %u 최고 점수를 기록합니다.\n", player.highscore);
  printf("=============================================================\n");
}

void jackpot(){
  printf("*+*+*+*+* 잭팟 *+*+*+*+*+*\n");
  printf("100 크레딧의 잭팟에 당첨됐습니다.\n");
  player.credits += 100;
}

void input_name(){
  char *name_ptr, input_char = '\n';
  while(input_char == '\n'){
    scanf("%c", &input_char);
  }

  name_ptr = (char *) &(player.name);
  while(input_char != '\n') {
    *name_ptr = input_char;
    scanf("%c", &input_char);
    name_ptr++;
  }

  *name_ptr = 0;
}


