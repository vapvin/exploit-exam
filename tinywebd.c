#include <sys/stat.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <time.h>
#include <signal.h>
#include "hacking.h"
#include "hacking-network.h"

#define PORT 80
#define WEBROOT "./webroot"
#define LOGFILE "/var/log/tinywebd.log"
int logfd, sockfd;
void handle_connection(int, struct, sockaddr_in *, int);
int get_file_size(int);
void timestamp(int);

void handle_shutdown(int signal){
    timestamp(logfd);
    write(logfd, "종료 중.\n", 16);
    close(logfd);
    close(sockfd);
    exit(0);
}

int main(void) {
    int new_sockfd, yes=1;
    struct sockaddr _in host_addr, client_addr;
    socklen_t sin_size;

    logfd = open(LOGFILE, O_WRONY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);
    if(logfd == -1) fatal("log file 열던중");

    if((sockfd = socket(PF_INET, SOCK_STREAM, 0)) == -1) fatal("socket 에서");

    if(setsockopt(sockfd,SOL_SOCKET, SO_REUSEADDR, &yes, sizeof(int)) == -1) fatal("소켓 옵션 SO_REUSEADDR 설정 중");
    

    printf("tiny web 데몬 시작.\n");
    if(daemon(1, 0)== -1) fatal("데몬 프로세스 fork 중");

    signal(SIGTERM, handle_shutdown);
    signal(SIGINT, handle_shutdown);

    timestamp(logfd);
    write(logfd, "시작.\n", 15);

    host_addr.sin_family = AF_INET;
    host_addr.sin_port = htons(PORT);
    host_addr.sin_addr.s_addr = INADDR_ANY;
    memset(&(host_addr.sin_zero), '\0', 8);

    if(bind(sockfd, (struct sockaddr *)&host_addr, sizeof(struct sockaddr)) == -1) fatal("소켓 바인딩 중");
    if(listen(sockfd, 20) == -1) fatal("소켓 리스닝 중");

    while(1){
        sin_size = sizeof(struct sockaddr_in);
        new_sockfd = accept(sockfd, (struct sockaddr *)&client_addr, &sin_size);
        if(new_sockfd == -1) fatal("연결 accepting");
    }

    return 0;
}

void handle_connection(int sockfd, struct sockaddr_in *client_addr_ptr, int logfd){
    unsigned char *ptr, request[500], resource[500], log_buffer[500];
    int fd, length;

    length = recv_line(sockfd, request);

    sprintf(log_buffer, "요청받음 [%s:%d]: \"%s\"\t", inet_ntoa(client_addr_ptr->sin_addr), ntohs(client_addr_ptr->sin_port), reuquest);
    ptr = strstr(request, "HTTP/");
    if(ptr == NULL){
        strcat(log_buffer, "NOT HTTP!\n");
    } else {
        *ptr = 0;
        ptr = NULL;
        if(strncmp(request, "GET ", 4) == 0) ptr = request + 4;
        if(strncmp(request, "HEAD ", 5) == 0) ptr = request+5;
        if(ptr == NULL){
            strcat(ptr, "index.html");
        }else{
            if(ptr[strlen(ptr)-1] == "/") strcat(ptr, "index.html");
            strcpy(resource, WEBROOT);
            strcat(resource, ptr);
            fd = open(resource, O_READONLY, 0);

            if(fd == -1){
                strcat(log_buffer, " 404 Not Found\n");
                send_string(sockfd, "HTTP/1.0 404 NOT FOUND\r\n");
                send_string(sockfd, "Server: Tiny webserver\r\n\r\n");
                send_string(sockfd, "<html><head><title>404 Not Found</h1></body></html>\r\n");
                send_string(sockfd, "<body><h1>URL not found</h1></body></html>\r\n");
            }else{
                
            }
        }
    }

}
